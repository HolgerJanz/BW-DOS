mads 2.0.9
Source: /Users/holgerjanz/Documents/ATARI-XL/Projects/RAMCART/BW-DOS/DOS/CHKDSK.ASM
     1 				; CHKDSK for SpartaDOS 16k
     2
     3 				;
     4 				; System equates
     5 				;
     6 = 0000			ICHID       equ $0000
     7 = 0001			ICDNO       equ $0001
     8 = 0002			ICCOM       equ $0002
     9 = 0003			ICSTA       equ $0003
    10 = 0004			ICBAL       equ $0004
    11 = 0005			ICBAH       equ $0005
    12 = 0006			ICPTL       equ $0006
    13 = 0007			ICPTH       equ $0007
    14 = 0008			ICBLL       equ $0008
    15 = 0009			ICBLH       equ $0009
    16 = 000A			ICAX1       equ $000A
    17 = 000B			ICAX2       equ $000B
    18 = 000C			ICAX3       equ $000C
    19 = 000D			ICAX4       equ $000D
    20 = 000E			ICAX5       equ $000E
    21 = 000F			ICAX6       equ $000F
    22 = 0080			ADLI        equ $0080
    23 = 0040			AVB         equ $0040
    24 = 0040			ALMS        equ $0040
    25 = 0020			AVSCR       equ $0020
    26 = 0010			AHSCR       equ $0010
    27 = 0001			AJMP        equ $0001
    28 = 0000			AEMPTY1     equ $0000
    29 = 0010			AEMPTY2     equ $0010
    30 = 0020			AEMPTY3     equ $0020
    31 = 0030			AEMPTY4     equ $0030
    32 = 0040			AEMPTY5     equ $0040
    33 = 0050			AEMPTY6     equ $0050
    34 = 0060			AEMPTY7     equ $0060
    35 = 0070			AEMPTY8     equ $0070
    36 = 000A			DOSVEC      equ $000A
    37 = 0340			IOCB0       equ $0340
    38 = E456			CIOV        equ $E456
    39 = E474			WARMSV      equ $E474
    40 				;
    41 				; Code equates
    42 				;
    43 = 0080			L0080       equ $0080
    44 = 0082			L0082       equ $0082
    45 = 0083			L0083       equ $0083
    46 = 0084			L0084       equ $0084
    47 = 0700			L0700       equ $0700
    48 = 0703			L0703       equ $0703
    49 = 0704			L0704       equ $0704
    50 = 070A			L070A       equ $070A
    51
    52
    53 				;CHKBUF      equ $6400      ; CHKDSK buffer
    54 = 06CD			CHKBUF_V    equ CHKBUF     ; fs version
    55 = 06CE			CHKBUF_SS   equ CHKBUF+1   ; sector size
    56 = 06CF			CHKBUF_SC   equ CHKBUF+2   ; sector count
    57 = 06D1			CHKBUF_SF   equ CHKBUF+4   ; dector free
    58 = 06D3			CHKBUF_NAM  equ CHKBUF+6   ; volume name
    59 = 06DB			CHKBUF_SN   equ CHKBUF+14  ; sequence number
    60 = 06DC			CHKBUF_RN   equ CHKBUF+15  ; random number
    61
    62 				;
    63 				; Start of code
    64 				;
    65 				            org $500
    66 				;
    67 FFFF> 0500-06CC> AD 00 + start       lda L0700              ; AD 00 07
    68 0503 C9 53		            cmp #'S'               ; C9 53
    69 0505 D0 0E		            bne L608C              ; D0 0E
    70 0507 AD 03 07		            lda L0703              ; AD 03 07
    71 050A C9 42		            cmp #'B'               ; C9 42
    72 050C D0 07		            bne L608C              ; D0 07
    73 050E AD 04 07		            lda L0704              ; AD 04 07
    74 0511 C9 57		            cmp #'W'               ; C9 57
    75 0513 F0 1D		            beq L60A9              ; F0 1D
    76 0515 20 59 06		L608C       jsr print              ; 20 03 60
    77 0518 9B FD		            .byte $9B,$FD
    78 051A 45 72 72 6F 72 3A +             .byte 'Error: Not BW-DOS !'
    79 052D 9B 00		            .byte $9B,$00
    80 052F 6C 0A 00		            jmp (DOSVEC)           ; 6C 0A 00
    81
    82 0532 A5 0A		L60A9       lda DOSVEC             ; A5 0A
    83 0534 18			            clc                    ; 18
    84 0535 69 03		            adc #$03               ; 69 03
    85 0537 8D 91 06		            sta _CRNAME+1            ; 8D 3B 60
    86 053A A5 0B		            lda DOSVEC+1           ; A5 0B
    87 053C 69 00		            adc #$00               ; 69 00
    88 053E 8D 92 06		            sta _CRNAME+2            ; 8D 3C 60
    89 0541 A5 0A		            lda DOSVEC             ; A5 0A
    90 0543 38			            sec                    ; 38
    91 0544 E9 13		            sbc #$13               ; E9 13
    92 0546 85 80		            sta L0080              ; 85 80
    93 0548 A5 0B		            lda DOSVEC+1           ; A5 0B
    94 054A E9 00		            sbc #$00               ; E9 00
    95 054C 85 81		            sta L0080+1            ; 85 81
    96 054E 20 90 06		            jsr _CRNAME              ; 20 3A 60
    97 0551 20 C3 06		            jsr L606D              ; 20 6D 60
    98 0554 A2 10		            ldx #$10               ; A2 10
    99 0556 A9 2F		            lda #$2F ; chkdsk       ; A9 2F
   100 0558 9D 42 03		            sta IOCB0+ICCOM,X      ; 9D 42 03
   101 055B A5 0A		            lda DOSVEC             ; A5 0A
   102 055D 18			            clc                    ; 18
   103 055E 69 21		            adc #$21               ; 69 21
   104 0560 9D 44 03		            sta IOCB0+ICBAL,X      ; 9D 44 03
   105 0563 A5 0B		            lda DOSVEC+1           ; A5 0B
   106 0565 69 00		            adc #$00               ; 69 00
   107 0567 9D 45 03		            sta IOCB0+ICBAH,X      ; 9D 45 03
   108 056A A9 CD		            lda #<CHKBUF           ; A9 00
   109 056C 9D 48 03		            sta IOCB0+ICBLL,X      ; 9D 48 03
   110 056F A9 06		            lda #>CHKBUF               ; A9 64
   111 0571 9D 49 03		            sta IOCB0+ICBLH,X      ; 9D 49 03
   112 0574 20 56 E4		            jsr CIOV               ; 20 56 E4
   113 0577 10 03		            bpl L60F3              ; 10 03
   114 0579 4C 93 06		            jmp L603D              ; 4C 3D 60
   115 057C 20 59 06		L60F3       jsr print              ; 20 03 60
   116 057F 9B			            .byte $9B
   117 0580 20 20 20 20 20 20 +             .byte '      Volume: '
   118 058E 00			            .byte $00
   119 058F A0 D3		            ldy #<CHKBUF_NAM       ; A0 06
   120 0591 A2 06		            ldx #>CHKBUF_NAM       ; A2 64
   121 0593 A9 08		            lda #$08               ; A9 08
   122 0595 20 41 06		            jsr prnChars           ; 20 B8 61
   123 0598 AD DB 06		            lda CHKBUF_SN          ; AD 0E 64
   124 059B 20 1C 06		            jsr prnDecA            ; 20 93 61
   125 059E AD DC 06		            lda CHKBUF_RN              ; AD 0F 64
   126 05A1 20 1C 06		            jsr prnDecA            ; 20 93 61
   127 05A4 20 59 06		            jsr print              ; 20 03 60
   128 05A7 9B			            .byte $9B
   129 05A8 42 79 74 65 73 2F +             .byte 'Bytes/sector:'
   130 05B5 00			            .byte $00
   131 05B6 A2 00		            ldx #$00               ; A2 00
   132 05B8 AD CE 06		            lda CHKBUF_SS              ; AD 01 64
   133 05BB D0 01		            bne L6135              ; D0 01
   134 05BD E8			            inx                    ; E8
   135 05BE 20 1E 06		L6135       jsr prnDecAX              ; 20 95 61
   136 05C1 20 59 06		            jsr print              ; 20 03 60
   137 05C4 9B			            .byte $9B
   138 05C5 20 54 6F 74 61 6C +             .byte ' Total bytes: '
   139 05D3 00			            .byte $00
   140 05D4 A0 02		            ldy #$02               ; A0 02
   141 05D6 20 F9 05		            jsr prnDecChk              ; 20 70 61
   142 05D9 20 59 06		            jsr print              ; 20 03 60
   143 05DC 9B			            .byte $9B
   144 05DD 20 20 42 79 74 65 +             .byte '  Bytes free: '
   145 05EB 00			            .byte $00
   146 05EC A0 04		            ldy #$04               ; A0 04
   147 05EE 20 F9 05		            jsr prnDecChk              ; 20 70 61
   148 05F1 A9 9B		            lda #$9B               ; A9 9B
   149 05F3 20 7D 06		            jsr put_char              ; 20 27 60
   150 05F6 4C BA 06		            jmp L6064              ; 4C 64 60
   151
   152 05F9 A9 08		prnDecChk   lda #$08               ; A9 08
   153 05FB 48			            pha                    ; 48
   154 05FC A9 00		            lda #$00               ; A9 00
   155 05FE 48			            pha                    ; 48
   156 05FF B9 CD 06		            lda CHKBUF,Y            ; B9 00 64
   157 0602 AA			            tax                    ; AA
   158 0603 B9 CE 06		            lda CHKBUF+1,Y            ; B9 01 64
   159 0606 A0 00		            ldy #$00               ; A0 00
   160 0608 2C CE 06		            bit CHKBUF_SS              ; 2C 01 64
   161 060B 10 18		            bpl L619C              ; 10 18
   162 060D 4A			            lsr                    ; 4A
   163 060E 48			            pha                    ; 48
   164 060F 8A			            txa                    ; 8A
   165 0610 6A			            ror                    ; 6A
   166 0611 AA			            tax                    ; AA
   167 0612 98			            tya                    ; 98
   168 0613 6A			            ror                    ; 6A
   169 0614 A8			            tay                    ; A8
   170 0615 68			            pla                    ; 68
   171 0616 4C 25 06		            jmp L619C              ; 4C 9C 61
   172
   173 0619 6C 0A 07		CONVDC_V    jmp (L070A)            ; 6C 0A 07
   174
   175 061C A2 00		prnDecA     ldx #$00               ; A2 00
   176 061E A8			prnDecAX    tay                    ; A8
   177 061F A9 04		            lda #$04               ; A9 04
   178 0621 48			            pha                    ; 48
   179 0622 48			            pha                    ; 48
   180 0623 A9 00		            lda #$00               ; A9 00
   181 0625 48			L619C       pha                    ; 48
   182 0626 98			            tya                    ; 98
   183 0627 A0 0D		            ldy #$0D               ; A0 0D
   184 0629 91 80		            sta (L0080),Y          ; 91 80
   185 062B C8			            iny                    ; C8
   186 062C 8A			            txa                    ; 8A
   187 062D 91 80		            sta (L0080),Y          ; 91 80
   188 062F C8			            iny                    ; C8
   189 0630 68			            pla                    ; 68
   190 0631 91 80		            sta (L0080),Y          ; 91 80
   191 0633 20 19 06		            jsr CONVDC_V              ; 20 90 61
   192 0636 68			            pla                    ; 68
   193 0637 18			            clc                    ; 18
   194 0638 65 80		            adc L0080              ; 65 80
   195 063A A8			            tay                    ; A8
   196 063B A9 00		            lda #$00               ; A9 00
   197 063D 65 81		            adc L0080+1            ; 65 81
   198 063F AA			            tax                    ; AA
   199 0640 68			            pla                    ; 68
   200 0641 84 82		prnChars    sty L0082              ; 84 82
   201 0643 86 83		            stx L0083              ; 86 83
   202 0645 85 84		            sta L0084              ; 85 84
   203 0647 A0 00		L61BE       ldy #$00               ; A0 00
   204 0649 B1 82		            lda (L0082),Y          ; B1 82
   205 064B 20 7D 06		            jsr put_char              ; 20 27 60
   206 064E E6 82		            inc L0082              ; E6 82
   207 0650 D0 02		            bne L61CB              ; D0 02
   208 0652 E6 83		            inc L0083              ; E6 83
   209 0654 C6 84		L61CB       dec L0084              ; C6 84
   210 0656 D0 EF		            bne L61BE              ; D0 EF
   211 0658 60			            rts                    ; 60
   212
   213 0659 68			print       pla                    ; 68
   214 065A 8D 6A 06		            sta L6013+1            ; 8D 14 60
   215 065D 68			            pla                    ; 68
   216 065E 8D 6B 06		            sta L6013+2            ; 8D 15 60
   217 0661 EE 6A 06		L600B       inc L6013+1            ; EE 14 60
   218 0664 D0 03		            bne L6013              ; D0 03
   219 0666 EE 6B 06		            inc L6013+2            ; EE 15 60
   220 0669 AD FF FF		L6013       lda $FFFF              ; AD FF FF
   221 066C F0 06		            beq L601E              ; F0 06
   222 066E 20 7D 06		            jsr put_char           ; 20 27 60
   223 0671 4C 61 06		            jmp L600B              ; 4C 0B 60
   224 0674 AD 6B 06		L601E       lda L6013+2            ; AD 15 60
   225 0677 48			            pha                    ; 48
   226 0678 AD 6A 06		            lda L6013+1            ; AD 14 60
   227 067B 48			            pha                    ; 48
   228 067C 60			L6026       rts                    ; 60
   229
   230 067D A8			put_char    tay                    ; A8
   231 067E A9 00		            lda #$00               ; A9 00
   232 0680 AA			            tax                    ; AA
   233 0681 9D 48 03		            sta IOCB0+ICBLL,X      ; 9D 48 03
   234 0684 9D 49 03		            sta IOCB0+ICBLH,X      ; 9D 49 03
   235 0687 A9 0B		            lda #$0B ; put chars   ; A9 0B
   236 0689 9D 42 03		            sta IOCB0+ICCOM,X      ; 9D 42 03
   237 068C 98			            tya                    ; 98
   238 068D 4C 56 E4		            jmp CIOV               ; 4C 56 E4
   239
   240 0690 4C 7C 06		_CRNAME     jmp L6026              ; 4C 26 60
   241
   242 0693 98			L603D       tya                    ; 98
   243 0694 48			            pha                    ; 48
   244 0695 20 59 06		            jsr print              ; 20 03 60
   245 0698 9B			            .byte $9B
   246 0699 45 72 72 6F 72	            .byte 'Error'
   247 069E 00			            .byte $00
   248 069F 68			            pla                    ; 68
   249 06A0 20 1C 06		            jsr prnDecA            ; 20 93 61
   250 06A3 A9 9B		            lda #$9B               ; A9 9B
   251 06A5 20 7D 06		            jsr put_char           ; 20 27 60
   252 06A8 A0 08		            ldy #$08               ; A0 08
   253 06AA B1 0A		            lda (DOSVEC),Y         ; B1 0A
   254 06AC 8D B8 06		            sta L6061+1            ; 8D 62 60
   255 06AF C8			            iny                    ; C8
   256 06B0 B1 0A		            lda (DOSVEC),Y         ; B1 0A
   257 06B2 8D B9 06		            sta L6061+2            ; 8D 63 60
   258 06B5 A0 01		            ldy #$01               ; A0 01
   259 06B7 20 74 E4		L6061       jsr WARMSV             ; 20 74 E4
   260 06BA 20 C3 06		L6064       jsr L606D              ; 20 6D 60
   261 06BD 6C 0A 00		            jmp (DOSVEC)           ; 6C 0A 00
   262
   263 06C0 01 0A 64		            .byte 1,10,100
   264
   265 06C3 A2 10		L606D       ldx #$10               ; A2 10
   266 06C5 A9 0C		            lda #$0C ; close       ; A9 0C
   267 06C7 9D 42 03		            sta IOCB0+ICCOM,X      ; 9D 42 03
   268 06CA 4C 56 E4		            jmp CIOV               ; 4C 56 E4
   269 = 06CD			CHKBUF      equ *
